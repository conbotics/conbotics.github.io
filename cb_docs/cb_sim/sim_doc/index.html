
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.3">
    
    
      
        <title>Documentation - MalerRoboter Docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#documentation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="MalerRoboter Docs" class="md-header__button md-logo" aria-label="MalerRoboter Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MalerRoboter Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Documentation
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="MalerRoboter Docs" class="md-nav__button md-logo" aria-label="MalerRoboter Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    MalerRoboter Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../support/troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      
        Table of Contents
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Table of Contents">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-set-up" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Set-Up
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-startrun" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Start/Run
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-debuggingissues" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Debugging/Issues
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-set-up_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Set-Up
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-connection-startrun" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Connection &amp; Start/Run
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-debugging" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Debugging
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Debugging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#related-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Related Issues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minor-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Minor Issues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#active-warningserrors" class="md-nav__link">
    <span class="md-ellipsis">
      
        Active Warnings/Errors
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#know-how" class="md-nav__link">
    <span class="md-ellipsis">
      
        Know-How:
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gzweb-related" class="md-nav__link">
    <span class="md-ellipsis">
      
        GZWEB-related
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#networks-related" class="md-nav__link">
    <span class="md-ellipsis">
      
        Networks-related
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="documentation">Documentation</h1>
<h2 id="table-of-contents">Table of Contents</h2>
<h3 id="1-set-up"><a href="#1-set-up">1. Set-Up</a></h3>
<h3 id="2-startrun"><a href="#2-connection--startrun">2. Start/Run</a></h3>
<h3 id="3-debuggingissues"><a href="#3-debugging">3. Debugging/Issues</a></h3>
<hr />
<h2 id="1-set-up_1">1. Set-Up</h2>
<ol>
<li>
<p>Make sure the following repos are checked out under simulation branch <strong>feat-sim</strong>:</p>
</li>
<li>
<p>cb_sprayarm</p>
</li>
<li>cb_base</li>
<li>cb_bringup</li>
<li>cb_config</li>
<li>cb_core</li>
<li>cb_vision</li>
</ol>
<p>To checkout to the corresponding branch in all the repositories:</p>
<pre><code class="language-bash">vcs custom --args checkout feat-sim
</code></pre>
<ol>
<li>
<p>Make sure your bash environment has the variables <code>ARM_NUMBER</code>, <code>BASE_NUMBER</code>, and <code>ROBOT_NUMBER</code> set.</p>
</li>
<li>
<p>Make sure both <code>simulation</code> flags (<code>config/general/process/simulation</code> and <code>config/sprayarm/settings/simulation</code>) are set to <code>true</code> inside <code>cb_config/process_configs/process.yaml</code></p>
</li>
<li>
<p>To control via the GUI app, build the <a href="https://github.com/conbotics/cb_ui_app">UI</a> on your machine, and run it in a terminal window. In the cb_ui_app folder, run:</p>
</li>
</ol>
<pre><code class="language-bash">docker compose up -d
</code></pre>
<ul>
<li>
<p>for docker.io to work, you'll need docker.io</p>
</li>
<li>
<p>In a browser, go to the address <code>http://localhost:5173</code> to view the app ,and from the splash screen, go to the Settings, and change the <strong>Robot IP</strong> to <code>localhost</code>. If you press the <code>Start</code> button now, it should say <code>Connected</code> in the top left corner.</p>
</li>
</ul>
<details>
  <summary><strong>Further tuning/setup</strong></summary>

#### Odometry tuning

- config file for odometry (I.e. which odometry topics to use) is located in `/cb/base/cb_navigation/cb_perception/config/ukf/ukf_cfg_tuned.yaml`

#### Camera Set-Up

- Inside `cb_sprayarm_description/urdf/modules` open **gazebo.xacro**
- This file configures the Gazebo simulation of the spray arm robot, defining materials, integrating ROS control, and setting up two depth cameras with specific parameters (FOV, resolution, update rate, clipping) and plugins to publish depth and point cloud data to ROS topics.

**Camera semantic segmentation**
- `cb_gazebo_plugins/src/gazebo_ros_semantic_camera.cpp`

#### Creating new worlds

- start gazebo standalone (so add. models I.e. Base, wheels etc. and their metrics dont get loaded in and saved in world file)
- if you start a pre-existing world make sure to remove the following line from the .world file before doing so:

<pre><code class="language-bash">    &lt;plugin name=&quot;ros_link_attacher_plugin&quot; filename=&quot;libgazebo_ros_link_attacher.so&quot;/&gt;
</code></pre>

**Gazebo standalone start**

<pre><code class="language-bash">gazebo ~/catkin_ws/src/cb_base/cb_base_gazebo/worlds/room_90s.world
</code></pre>

- Place objects I.e. boxes - transform with keys `S/R/T` (Scale/Rotation/Translation)
- After editing - save as new world. Edit Labels accordingly in the `.world` file for semantic segmentation.

**Labels are:** wall; ceiling; floor; other; door; window; person; suv; sprayarm

- re-introduce plugin after .world file is saved

<pre><code class="language-bash">    &lt;plugin name=&quot;ros_link_attacher_plugin&quot; filename=&quot;libgazebo_ros_link_attacher.so&quot;/&gt;
</code></pre>


`room_90s_long_wall_hole_obstacles.world`

- *map* gets selected inside `start_sim_world.launch`

![room_90s_long_wall_hole_obstacles](images/14.png "room_90s_long_wall_hole_obstacles")

#### Current IP

- `192.168.1.101` - local ip

</details>

<h2 id="2-connection-startrun">2. Connection &amp; Start/Run</h2>
<p>There are four ways to start/run the simulation:
* locally
* remotely on the same network (one user)
* remotely on the same network (many users)
* remotely on different network via Netbird (many users)</p>
<p>Currently, we use the last two approaches.</p>
<details>
  <summary><strong>2.1 Run the simulation locally inside the container</strong></summary>

### 2.1 Run the simulation locally inside the container

To run the simulation in a docker container, locally, on the SIM PC (or your own laptop if it can afford it), follow these steps:

- Start Docker Container:

<pre><code class="language-bash">start_ros
</code></pre>


- Join Docker Container from other sessions:

<pre><code class="language-bash">join_ros
</code></pre>


#### How to start gazebo simulation pipeline

- Start the GUI-bridge in the first session:

<pre><code class="language-bash">bridge
</code></pre>

launches: `roslaunch cb_bringup startup_node.launch`


- Start simulation pipeline in another docker session:

<pre><code class="language-bash">gazebo_pipe
</code></pre>

launches: `roslaunch cb_bringup start_all_gazebo.launch`

- Set wall height under `settings for all walls` in the GUI
- Wait until you see ```[attach_sprayarm-9] process has finished cleanly``` before unpausing the Gazebo simulation. (~5 sec)
- Access the [GUI](http://172.18.0.2:5173)


<pre><code class="language-bash">rviz -d ~/catkin_ws/src/cb_bringup/config/rviz_config/3d_visualizer.rviz
</code></pre>


</details>

<hr />
<details>
  <summary><strong>2.2 Run the simulation remotely (headless-mode) - SIM PC - Same network - one instance</strong></summary>

### 2.2 Run the simulation remotely (headless-mode) - SIM PC - Same network - one instance

To run the simulation in a docker container, remotely, on the SIM PC, while you are connected on the same network (as the SIM PC), follow these steps:


<pre><code class="language-bash">ssh conbotics@192.168.1.101
</code></pre>

#### ssh session #1


<pre><code class="language-bash">start_ros_hl

bridge
</code></pre>


#### ssh session #2


<pre><code class="language-bash">join_ros_hl

export DISPLAY=:1

gazebo_pipe
</code></pre>


#### local session

<pre><code class="language-bash">export ROS_MASTER_URI=http://192.168.1.101:11311
export ROS_IP=&lt;&lt;remote-ip&gt;&gt;

rviz
</code></pre>

  - for future comfort - add a function to your bash script:

<pre><code class="language-bash">roslocal() {
        export ROS_IP=192.168.1.253
        export ROS_MASTER_URI=http://192.168.1.101:11311/
        echo &quot;$ROS_IP&quot;
        echo &quot;$ROS_MASTER_URI&quot;
}
</code></pre>

#### ssh session #3
start the simulation by entering the following ros call:


<pre><code class="language-bash">rosservice call /gazebo/unpause_physics 

                /  ... /pause_physics - to pause the simulation
</code></pre>


  - in Rviz set **fixed frame** inside the global options header to **map**

#### ssh session #4 (Gazebo streaming)
start the streaming client for Gazebo


<pre><code class="language-bash">gzweb
</code></pre>

launches: `cd ~/gzweb && npm start -p 8081`

</details>

<hr />
<details>
  <summary><strong>2.3 Run the simulation remotely (headless mode) - SIM PC - Same network - Multiple instances</strong></summary>

### 2.3 Run the simulation remotely (headless mode) - SIM PC - Same network - Multiple instances

To run multiple instances of the simulation in a docker container, remotely, on the SIM PC, while you are connected on the same network (as the SIM PC), follow these steps:

**NOTE:**
The workspaces - (located at `~/WS/`) - that are set up as of now are the following:
  - develop
  - testing
  - vision
  - sim_1, sim_2, sim_3, sim_4 
  - additionally every person working on the sim should create their own workspace

#### State 27.11

  - workspace **develop** got every repo that was on `feat-sim` updated by merging the `production`branch into them
    - the repos that were on develop were updated to production
  - workspace **develop** was then used as the basis for every other workspace

---

**Quick overview:**
1. Connect via ssh
2. Start/Join container
3. Run the bridge nodes
4. Run the Gazebo nodes
5. Start gazebo interactive web view server
6. Configure each access point (whether it be remote rviz, gzweb, GUI)

---

#### start/run multiple sims

##### **1.** 

<pre><code class="language-bash">ssh conbotics@192.168.1.101
</code></pre>

- 3 seperate `ssh` sessions should suffice for the basic pipeline

##### **2.** 


<pre><code class="language-bash">start_roshl develop 2

join_roshl develop 2
</code></pre>


- **1st argument** `develop` selects the workspace (name of the workspace inside ~/WS/ Dir.)
  - maps ~/WS/develop/catkin_ws to ~/catkin_ws inside the docker
- **2nd argument** `2` sets the instance number - This way each container gets a unique IP by using the `Macvlan` network configuration
  - this iterates the assigned container IP up by the specified instance number

**Output:**

<pre><code class="language-bash">Starting container: ros-noetic-develop-2-hl
Assigned IP: 192.168.1.202
ROS_MASTER_URI: http://192.168.1.202:11311
GAZEBO_MASTER_URI: http://192.168.1.202:11345
Workspace: /home/conbotics/WS/develop/catkin_ws
</code></pre>


##### **3.** 


<pre><code class="language-bash">bridge
</code></pre>

  - use the configuration example as shown in **Access Points**
  - Wait until you see something along the lines of `MR05 (Simulation)` in the upper left corner of your gui
  - Restart if it only shows disconnected

##### **4.** 


<pre><code class="language-bash">gazebo_pipe
</code></pre>

  - If `attach failed` **error** appears or `gazebo-1` process **error** -> restart `gazebo_pipe` - bridge does not need to be restarted

##### **5.** 


<pre><code class="language-bash">gzweb
</code></pre>

**launches:** cd ~/gzweb && npm start -p 8081

- To start the gazebo sim, *either* enter:


<pre><code class="language-bash">rosservice call /gazebo/unpause_physics
</code></pre>

**.OR.**

- press on play inside gzweb (the interactive gazebo web page)

##### **6.** 

###### Access Points (for given example above):

`GUI_APP` Network setting: `IP`: 192.168.1.202 `Port`: 9090

- inside `settings for all walls` - enter a plausible `ceiling height` - otherwise the builder will fail

`Gazebo Online view` Address: **192.168.1.202**:8081

###### Remote Rviz

`ROS_IP`: **Remote machine IP**

`ROS_MASTER_URI`: http://192.168.1.202:11311

##### Extra utilities

###### How to see which and how many simulations are running

- inside terminal just enter `list_sims`


<pre><code class="language-bash">--- Running ROS Noetic Simulations ---
INSTANCE ID     WORKSPACE            IP ADDRESS      CONTAINER NAME                          
--------------------------------------------------------------------------------------------
1               atlas                192.168.1.201   ros-noetic-atlas-1-hl                   
2               develop              192.168.1.202   ros-noetic-develop-2-hl                 
--------------------------------------------------------------------------------------------
Total Simulations Running: 2
</code></pre>


**Bash script for ROS env var export**


<pre><code class="language-bash">rosremote() {
        local instance=$1
        local ip_base=200
        local ip_sfx=$((ip_base + instance))
        local ros_ip=192.168.1.${ip_sfx}

        export ROS_IP=$(hostname -I | awk '{print $1}')
        export ROS_MASTER_URI=http://${ros_ip}:11311
        echo &quot;$ROS_IP&quot;
        echo &quot;$ROS_MASTER_URI&quot;

}
</code></pre>


**USAGE:**

`rosremote 2` - would set the ip for the given container, i.e. `IP` for `instance 2`

---

##### How to change the map
1. In cb_base/cb_base_gazebo/launch/start_sim_world.launch change line 10 to the prefered world:

<pre><code class="language-start_sim_world.launch">&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;launch&gt;
    &lt;arg name=&quot;paused&quot; default=&quot;false&quot; doc=&quot;Starts gazebo in paused mode&quot;/&gt;
    &lt;arg name=&quot;gui&quot; default=&quot;false&quot; doc=&quot;Starts gazebo gui&quot;/&gt;
    &lt;arg name=&quot;verbose&quot; default=&quot;false&quot; doc=&quot;verbose&quot;/&gt;
    &lt;arg name=&quot;extra_gazebo_args&quot; default=&quot;&quot; doc=&quot;extra gazebo args like --lockstep&quot;/&gt;
    &lt;!-- startup simulated world --&gt;
    &lt;include file=&quot;$(find gazebo_ros)/launch/empty_world.launch&quot;&gt;
        &lt;arg name=&quot;world_name&quot;
             default=&quot;$(find cb_gazebo_worlds)/worlds/appartement_singapore_no_doors_ceiling.world&quot;/&gt;
        &lt;arg name=&quot;paused&quot; value=&quot;$(arg paused)&quot;/&gt;
        &lt;arg name=&quot;gui&quot; value=&quot;$(arg gui)&quot;/&gt;
        &lt;arg name=&quot;verbose&quot; value=&quot;$(arg verbose)&quot;/&gt;
        &lt;!-- &lt;arg name=&quot;extra_gazebo_args&quot; value=&quot;$(arg extra_gazebo_args)&quot;/&gt; --&gt;
    &lt;/include&gt;
&lt;/launch&gt;
</code></pre>

2. In cb_bringup/launch/start_all_gazebo.launch change the spawn x and y coordinates to the desired location. (Leave Z untouched)

Note: For the Singapore appartements the X and Y coordinates for the individual rooms are as following:

Room A: x: 11.0 y:  0.5

Room B: x:  7.0 y:  2.5

Room C: x:  4.0 y:  2.5

Room D: x:  1.5 y:  2.3

Room E: x:  7.0 y: -0.2


##### Sim Numbers

Shirin: 2

Liam: 3

Ahmad: 5

Kevin: 6

David: 7

Peter: 8

Barbara: 11

Anton: 12

Rosh: 13

Konstantin: 14

Talha: 24

Alex: 31

Jose: 4


</details>

<hr />
<details>
  <summary><strong>2.4 Run the simulation remotely (headless mode) - SIM PC - Netbird - Multiple instances</strong></summary>

### 2.4 Run the simulation remotely (headless mode) - SIM PC - Netbird - Multiple instances

To run multiple instances of the simulation in a docker container, remotely, on the SIM PC, via Netbird - while you are connected on a different network (than the SIM PC), follow these steps.


#### 1. Connect to the SIM PC remotely via Netbird:


<pre><code>ssh conbotics@100.114.232.9 
</code></pre>


#### 1.5. Change branch on the repos

**NOTE**: This step will be removed, once we merge feat-sim-one-launch-file-to-rule-all into feat-sim (and eventually into current) branch.
Head to your workspace (eg `~/WS/alex/catkin_ws`) and run:

<pre><code>vcs custom --args checkout current
vcs custom --args checkout feat-sim
vcs custom --args checkout feat-sim-one-launch-file-to-rule-all
</code></pre>

Once you do this step once, you change the branches of your workspace and you don't have to run it again unless you want to change back to `feat-sim` or `current`.

#### 2. Run the container

The following container: 
- mimics the startup system of the real robot. I.e. it first launches all the nodes (startup_node.launch) that run when we power on the real robot, in a simulated environment, and then it launches the rest of the nodes, that run when we `Initialize` the real robot. So it makes use of the same catmux environment.
- mounts the workspace of the SIM PC that you defined (eg `WS/alex/catkin_ws`), in the `~/workspace/catkin_ws` of the container. Based on it, it creates a new robot_folders environment, `simulation` in the `~/workspace/simulation` directory of the container. It activates the `simulation` environment and copies the workspace that you defined, in that directory.
- works both when you are on the same network (lan) or different (via netbird).



<pre><code># You may first need to stop a previous instance of the container:
# docker compose -p sim_&lt;ws_name&gt;_&lt;instance_number&gt; down
cd ~/cb_docker/ros-noetic
mstart_compose_ros_noetic_hl_sim &lt;ws_name&gt; &lt;instance_number&gt; [Optional: &lt;network_type&gt; &lt;build&gt;]
# eg mstart_compose_ros_noetic_hl_sim develop 2 netbird
</code></pre>


- <ws_name>: refers to the workspace (eg `develop`, `alex` etc), similar to point 2.3. Defaults to `develop`. 
- <instance_number>: refers to the instance number for the specific user (eg `2` for alex and so on). Defaults to `1`.
- <network_type>: `lan` or `netbird` [Optional] to choose whether you are on the same network (lan) as the SIM PC, or different (netbird). Defaults to `lan`.
- <build> [Optional]: Whether or not to rebuild the container image. Defaults to `false`. Eg, you want to install a new package in the container, and have it being consistent across runs.

#### 3. Set some variables

Inside the container, run the following commands to set some variables:


<pre><code>source .bashrc
setvars MR05
</code></pre>


#### 4. Start the system

The following command represents the same state, as if powering on the system of the real robot, but in simulation. On the same terminal, run:

<pre><code>robce simulation
</code></pre>


#### 5. Initialize the robot

The following command represents the same state, as if initializing the real robot, but in simulation. On the same terminal, run:

<pre><code>initialize --simulation
</code></pre>

- Adding a `--vision` parameter, also starts the vision node:

<pre><code>initialize --simulation --vision
</code></pre>


#### 6. Start gzweb
Open a 2nd terminal:

<pre><code>ssh -L 8081:172.20.0.231:8081 -L 9090:172.20.0.231:9090 conbotics@100.114.232.9
</code></pre>

Enter the gzweb container:

<pre><code>docker exec -u conbotics -it ros-gzweb-alex-31 /bin/bash
</code></pre>

Verify that the custom models (base and sprayarm) are deployed for gzweb:

<pre><code>ls gzweb/http/client/assets | grep cb
</code></pre>

If you don't see `cb_base_description` and `cb_sprayarm_description`
then run:

<pre><code>cd ~/gzweb
./deploy.sh -m
</code></pre>


Otherwise, start gzweb:

<pre><code>cd ~/gzweb/gzbridge
node server.js 8081
</code></pre>


To visualize it, head on your browser to the page:

<pre><code># http://192.168.1.231:8081/ if in the same network, or via netbird:
localhost:8081
</code></pre>


</details>

<hr />
<h2 id="3-debugging">3. Debugging</h2>
<details>
  <summary><strong>PlotJuggler</strong></summary>

For Debugging purposes - if a plotting tool is required - look no further and use `PlotJuggler`.


<pre><code class="language-bash">rosrun plotjuggler plotjuggler
</code></pre>

Can plot any topic - odometry, covariances etc...

![odometry plotjuggler](images/9.png "plotjuggler odometry")
- great for analyzing causation and correlation
- an extensive config file for odometry testing is inside `cb_bringup/config/plotjuggler/odometry_sim_2.xml`

</details>

<h3 id="related-issues">Related Issues</h3>
<details>
  <summary><strong>Issue #1 - Shift in Odometry</strong></summary>


#### Issue #1 - Shift in Odometry

  - Odometry "stutters/jitters" with bigger "hickups" occasionally happening

**related warning/info:** Getting odometry callbacks and found error

  - `/spraybot/navigation/long_base_motion_server`
  - `/spraybot/navigation/weighted_pid`

#### Status:

- Still occurs occasionally

</details>

<hr />
<details>
  <summary><strong>Issue #2 - Angular offset of Octomap</strong></summary>

#### Issue #2 - Angular offset of Octomap

  - angle error gets worse over time as the odometry "jitters" carry on 
  - there are parts of the message that show an accurate representation - likely stemming from older scans/messages

**Affected topics:** `/spraybot/perception/slam_rt/cloud_map` & `/spraybot/perception/slam_rt/octomap_full` 

![/spraybot/perception/slam_rt/octomap_full](images/1.png "/spraybot/perception/slam_rt/octomap_full")
![/spraybot/perception/slam_rt/cloud_map](images/2.png "/spraybot/perception/slam_rt/cloud_map")

#### Status:
- I used plotjuggler to analyze the odometries behaviour - on the right is the resulting odometry post kalman fusion - on the left the individual topics that make up the fusion
- I found the wheel odometry was publishing a topic regarding rotation (yaw) that only published 0 - making the resulting odometry oscillate between 0 and another odometry part values

**Affected topics:** `yaw; yaw velocity`

![Plot_Compare_ang_vel_z](images/11.png "plotjuggler Angular Velocity compare of z")

- Wheel odom for yaw and vel.-yaw was included in the ukf_cfg_tuned.yaml


</details>

<hr />
<details>
  <summary><strong>Issue #3 - Misallignment of robot towards wall </strong></summary>

#### Issue #3 - Misallignment of robot towards wall 

  - paint process aborts with an error due to robot gradually aligning with the "warped" wall
    - no feasible path can be found


#### Status:

- After testing the odometry topics and excluding possible faulty topics - the angular offset has vanished but the translatory offset still appears sometimes
- Error somewhat persists - does not occur as often

</details>

<hr />
<details>
  <summary><strong>Issue #4 - Wall on the right of the robot shows 1 big hole </strong></summary>

#### Issue #4 - Wall on the right of the robot shows 1 big hole 

  - to me this issue seems related to the arm "projection" removal - as that wall section starts off as being represented correctly for the most part

![/spraybot/perception/obstacle_extraction_transformed_octomap](images/3.png "/spraybot/perception/obstacle_extraction_transformed_octomap")
![/spraybot/perception/obstacle_extraction_transformed_octomap](images/4.png "/spraybot/perception/obstacle_extraction_transformed_octomap")
![/spraybot/perception/obstacle_extraction_transformed_octomap](images/5.png "/spraybot/perception/obstacle_extraction_transformed_octomap")

##### Status: 
For reasons beyond me that does not seem to be a problem anymore. 

</details>

<hr />
<details>
  <summary><strong>Issue #5 - faulty segmentation</strong></summary>

#### Issue #5 - faulty segmentation

  - arbitrary point classes are assigned - see image
  - (used camera plugin: `libgazebo_ros_semantic_camera`)

![libgazebo_ros_semantic_camera](images/6.png "libgazebo_ros_semantic_camera")
![libgazebo_ros_semantic_camera](images/7.png "libgazebo_ros_semantic_camera")

##### Status:

Fixed by editing the semantic camera plugin node code. Didnt register objects for segmentation if the Label had uppercase spelling.

**New World including "windows" :**

![Paint_process_working_seg](images/8.png "ros_semantic_camera")
![Paint_process_working_seg](images/12.png "ros_semantic_camera")
![segmentation_windows](images/10.png "ros_semantic_camera")
- lower image still shows a faulty "projection" onto wall cloud but that is of no consquence ...



  ##### Sub-Issue:
    - Segmentation of arm in the image gets projected onto wall. I.e. Arm removal in image (masking) isint working yet. 
      - Arm segmentation color-mapping set to wall color for now.

</details>

<hr />
<details>
  <summary><strong>Issue #6 - missing camera alignment</strong></summary>

#### Issue #6 - missing camera alignment

  - robot does not drive parallel to the wall - instead it does the corner alignment and starts the paint process from there on out

    ##### Status:
    - as of now, robot performs camer alignment - this was possibly due to `use_fake_states` being turned on in the `process.yaml` 


</details>

<hr />
<details>
  <summary><strong>Issue #7 - dynamic collision checking -> arm planner fails</strong></summary>

#### Issue #7 - dynamic collision checking -> arm planner fails

  - we started to implement the dynamic collision in moveit using the `/spraybot/perception/slam_rt/cloud_map`
    - the problem we encountered there was - that the octomap was build using the robots frame as the "static" map frame and the map was moving along with the robot

![moveit_collision](images/15.png "moveit_collision")


    - we solved this by changing the virtual joint inside `cb_sprayarm.srdf.xacro` to type `floating`and by using the map frame
      - resulted in the expected map building behaviour - but every other arm planning process broke because of that

**changed files:** `sensor_manager.launch.xml, cb_sprayarm.srdf.xacro, sensors_3d.yaml`

**Additionally this resulted in heavily oscillating odometry**

![moveit_collision_odom](images/pos_y_oscill.png "moveit_collision_odom")

</details>

<hr />
<h3 id="minor-issues">Minor Issues</h3>
<details>
  <summary><strong>Missing Base Model in gzweb</strong></summary>

#### Missing Base Model in gzweb
- since base isint part of gazebos model inventory - it needs to be hosted as part of the local models

- before re-deploying gzweb with the `-m` flag - the **GAZEBO_MODEL_PATH** needs to be set and the models need to be in that directory - or atleast a simlink - preferrably of the package containing the meshes (no path change in urdf/xacro needed then)

</details>

<hr />
<details>
  <summary><strong>Missing projection removal of sprayarm</strong></summary>

#### Missing projection removal of sprayarm

- since the sprayarm enters the field of view occasioanlly - it gets projected onto the segmented image
  - there is a projection removel mask in place - which isint yet working for the simulation

</details>

<hr />
<details>
  <summary><strong>GUI shows Disconnected</strong></summary>

#### GUI shows Disconnected
- GUI shows on every second or so bridge startup Disconnected as status
- if you then close the bridge `Ctrl+c` and let it properly close
  - the next bridge execution will then perform as expected
- requests such as refreshing the page are registered in bridge session

[bot_release-14] process has finished cleanly
log file: /home/conbotics/.ros/log/ce145aae-a8f6-11f0-9293-849e56028e8b/bot_release-14*.log
- seems to be a marker for the bridge being able to establish a connection

</details>

<hr />
<details>
  <summary><strong>Gazebo not properly starting</strong></summary>

#### Gazebo not properly starting
- Link connector for gazebo pipeline does not always start
- gzweb cant be started - physics cant be unpaused

</details>

<h3 id="active-warningserrors">Active Warnings/Errors</h3>
<details>
  <summary><strong>Gazebo related</strong></summary>

#### Gazebo related:

libGL error: failed to create dri screen
libGL error: failed to load driver: nouveau

[ERROR] [/gazebo:116]: No p gain specified for pid.  Namespace: /sprayarm/gazebo_ros_control/pid_gains/m1_joint
  - all throughout joints m1 to m5

[ERROR] [/gazebo:116]: No p gain specified for pid.  Namespace: /spraybot/base/gazebo_ros_control/pid_gains/spraybot/base/drive_wheel_left_joint
  -for both left and right wheel joint

</details>

<hr />
<details>
  <summary><strong>Others</strong></summary>

#### Others:

[INFO] [/spraybot/navigation/weighted_pid:394]: Getting odometry callbacks and found error.

[INFO] [/spraybot/navigation/long_base_motion_server:407]: Getting odometry callbacks and found error.

[WARN] (2025-09-26 13:07:36.470) SensorData.cpp:762::uncompressDataConst() Requested laser scan data, but the sensor data (42) doesn't have laser scan.

</details>

<hr />
<h3 id="know-how">Know-How:</h3>
<details>
  <summary><strong>How to convert modular URDF (I.e. multiple xacros) into .SDF</strong></summary>

#### How to convert modular URDF (I.e. multiple xacros) into .SDF

- .sdf folder structure (preferred type for gzweb)
  - GAZEBO_MODEL_PATH/cb_base/
    - meshes
    - materials
    - `model.config`
    - `cb_base.sdf`

- model paths in sdf/urdf/xacro have to be relative to *GAZEBO_MODEL_PATH*
  - `<mesh filename="model://..."/>`
- convert xacro -> urdf -> sdf 


<pre><code class="language-bash">xacro cb_base.xacro use_link_attacher:=false &gt; cb_base.urdf
.OR.
xacro cb_base.xacro robot_description:=spraybot/base/robot_description namespace:=spraybot/base sensors_ns:=spraybot/sensors use_link_attacher:=false &gt; cb_base.urdf

gz sdf -p cb_base.urdf &gt; cb_base.sdf
</code></pre>


- set: 

<pre><code class="language-bash">export GAZEBO_MODEL_PATH=~/catkin_ws/src/cb_base/cb_base_description/models
</code></pre>

- python not set inside Container so use python3 as default:

<pre><code class="language-bash">sudo ln -s /usr/bin/python3 /usr/bin/python
</code></pre>

- navigate to gzweb - use: 

<pre><code class="language-bash">npm run deploy --- -m
</code></pre>

- sources local and remote models
![gzweb_sdf_representation](images/13.png "gzweb")

</details>

<hr />
<h3 id="gzweb-related">GZWEB-related</h3>
<details>
  <summary><strong>Gzweb Set-Up</strong></summary>

#### Gzweb Set-Up

(TO-DO: needs to be included in dockerfile) - DONE

- `GAZEBO_MODEL_PATH` needs to be set prior to using the deploy command
  - all subsequent builds dont need the `-m`flag - it grabs all the models both locally and from the remote model database.
- **GZWEB** needs the "unique" models I.e. the ones that werent sourced/build from gazebo assets in a specified location to host them. (Sim link should be enough)
- Affected are the .STL files in the meshes directory
- both `body.xacro` and `caster_wheel.xacro` 


<pre><code class="language-bash">sudo apt install libjansson-dev imagemagick

curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh | bash

source ~/.bashrc

nvm install 8
  (use 10 - 8 didnt work for me...)

git clone https://github.com/osrf/gzweb &amp;&amp; cd ~/gzweb

git checkout gzweb_1.4.1

source /usr/share/gazebo/setup.sh

npm run deploy --- -m
</code></pre>

</details>

<hr />
<details>
  <summary><strong>GZWEB Usage</strong></summary>

#### GZWEB Usage

<pre><code class="language-bash">cd ~/gzweb

npm start -p 8081
  (idk why but port 8080 is not open for use)
</code></pre>

**hosted site:**
- `http://<local_ip>:8081/`


</details>

<hr />
<h3 id="networks-related">Networks-related</h3>
<details>
  <summary><strong>Forwarding/Masquerade</strong></summary>

#### Forwarding/Masquerade

<pre><code class="language-bash">sudo sysctl -w net.ipv4.ip_forward=1

sudo iptables -A FORWARD -i wlp13s0 -o docker0 -j ACCEPT
sudo iptables -A FORWARD -i docker0 -o wlp13s0 -j ACCEPT

sudo iptables -t nat -A POSTROUTING -s 172.17.0.0/16 -o wlp13s0 -j MASQUERADE
</code></pre>


</details>

<hr />
<details>
  <summary><strong>Macvlan network setup - allows for multiple simultaneous simulations</strong></summary>

#### Macvlan network setup - allows for multiple simultaneous simulations


<pre><code class="language-bash">docker network create -d macvlan \
  --subnet=192.168.1.0/24 \
  --gateway=192.168.1.1 \
  --ip-range=192.168.1.200/29 \
  -o parent=eno1 \
  ros_macvlan_net
</code></pre>

</details>

<hr />












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>